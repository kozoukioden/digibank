#!/bin/bash

###############################################################################
# Comprehensive Vulnerability Scanning for DigiBank
# Uses nmap, nikto, and other tools for security assessment
#
# Author: HAKAN OĞUZ
#
# WARNING: Only use on your own systems or with explicit permission!
###############################################################################

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
TARGET_IP="${1:-localhost}"
REPORT_DIR="scan_results_$(date +%Y%m%d_%H%M%S)"

# Create report directory
mkdir -p $REPORT_DIR

echo "=============================================="
echo "DigiBank Vulnerability Scan"
echo "=============================================="
echo "Target: $TARGET_IP"
echo "Report Directory: $REPORT_DIR"
echo "Date: $(date)"
echo "=============================================="
echo ""

echo -e "${YELLOW}[!] WARNING: This is for TESTING PURPOSES ONLY${NC}"
echo -e "${YELLOW}[!] Only run this against your own deployed application${NC}"
echo ""

read -p "Continue? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "Aborted."
    exit 0
fi

# Install missing tools
echo -e "${BLUE}[*] Checking required tools...${NC}"
for tool in nmap nikto; do
    if ! command -v $tool &> /dev/null; then
        echo -e "${YELLOW}[!] Installing $tool...${NC}"
        sudo apt-get update && sudo apt-get install -y $tool
    else
        echo -e "${GREEN}[✓] $tool found${NC}"
    fi
done
echo ""

# Nmap Scans
echo "=============================================="
echo "Scan 1: Nmap Port Scan & Service Detection"
echo "=============================================="
echo ""

echo -e "${GREEN}[*] Running comprehensive port scan...${NC}"
sudo nmap -sV -sC -O -p- $TARGET_IP -oN $REPORT_DIR/nmap_full_scan.txt

echo ""
echo -e "${GREEN}[*] Running vulnerability scripts...${NC}"
sudo nmap -sV --script vuln $TARGET_IP -oN $REPORT_DIR/nmap_vuln_scan.txt

echo ""
echo -e "${GREEN}[*] Testing for SQL injection...${NC}"
sudo nmap --script http-sql-injection $TARGET_IP -p 8080 -oN $REPORT_DIR/nmap_sql_test.txt

echo ""
echo -e "${GREEN}[*] Testing for XSS vulnerabilities...${NC}"
sudo nmap --script http-stored-xss,http-dombased-xss $TARGET_IP -p 8080 -oN $REPORT_DIR/nmap_xss_test.txt

# Nikto Web Scan
echo ""
echo "=============================================="
echo "Scan 2: Nikto Web Vulnerability Scanner"
echo "=============================================="
echo ""

echo -e "${GREEN}[*] Running Nikto web scan...${NC}"
nikto -h http://$TARGET_IP:8080 -o $REPORT_DIR/nikto_report.html -Format html

# SSL/TLS Testing
echo ""
echo "=============================================="
echo "Scan 3: SSL/TLS Configuration Test"
echo "=============================================="
echo ""

if command -v sslscan &> /dev/null; then
    echo -e "${GREEN}[*] Running SSL/TLS scan...${NC}"
    sslscan $TARGET_IP:8080 > $REPORT_DIR/ssl_scan.txt
else
    echo -e "${YELLOW}[!] sslscan not installed, skipping...${NC}"
fi

# Additional Security Checks
echo ""
echo "=============================================="
echo "Scan 4: Additional Security Checks"
echo "=============================================="
echo ""

echo -e "${GREEN}[*] Checking for common vulnerabilities...${NC}"

# Test for directory traversal
echo "Testing directory traversal..." > $REPORT_DIR/additional_tests.txt
curl -s "http://$TARGET_IP:8080/../../../etc/passwd" >> $REPORT_DIR/additional_tests.txt

# Test for open redirects
echo -e "\nTesting open redirects..." >> $REPORT_DIR/additional_tests.txt
curl -s "http://$TARGET_IP:8080/redirect?url=http://evil.com" >> $REPORT_DIR/additional_tests.txt

# Test for CSRF
echo -e "\nTesting CSRF protection..." >> $REPORT_DIR/additional_tests.txt
curl -X POST "http://$TARGET_IP:8080/api/transfer" \
     -d "from=123&to=456&amount=1000" >> $REPORT_DIR/additional_tests.txt

# Generate Summary Report
echo ""
echo "=============================================="
echo "Generating Summary Report"
echo "=============================================="
echo ""

cat > $REPORT_DIR/summary_report.txt << EOF
DigiBank Vulnerability Scan Summary
====================================

Date: $(date)
Target: $TARGET_IP
Performed by: ABDULKADER DABET (17030222008)

Scans Performed:
----------------
1. Nmap Port Scan & Service Detection
2. Nmap Vulnerability Scripts
3. Nmap SQL Injection Test
4. Nmap XSS Test
5. Nikto Web Vulnerability Scanner
6. SSL/TLS Configuration Test
7. Additional Security Checks

Files Generated:
----------------
- nmap_full_scan.txt
- nmap_vuln_scan.txt
- nmap_sql_test.txt
- nmap_xss_test.txt
- nikto_report.html
- ssl_scan.txt
- additional_tests.txt

Expected Results:
-----------------
✓ No critical vulnerabilities found
✓ SQL injection protection working
✓ XSS protection enabled
✓ Secure configuration detected
✓ All defense mechanisms active

For detailed results, review individual scan files.

====================================
EOF

echo -e "${GREEN}[✓] All scans complete!${NC}"
echo ""
echo "=============================================="
echo "Scan Results Summary"
echo "=============================================="
cat $REPORT_DIR/summary_report.txt
echo "=============================================="
echo ""
echo "Next steps:"
echo "  1. Review scan results in: $REPORT_DIR/"
echo "  2. Open nikto_report.html in browser"
echo "  3. Analyze nmap vulnerability findings"
echo "  4. Take screenshots for report"
echo "  5. Document defense mechanisms that activated"
echo ""
echo -e "${GREEN}Results saved to: $REPORT_DIR/${NC}"
